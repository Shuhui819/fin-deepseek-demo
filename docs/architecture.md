# 系统架构说明（V1）

 项目名称 ：基于 FinanceToolkit 的财务分析与可视化  
 阶段 ：Level 1 —— 数据与指标层  
 版本 ：v1.0  

---

## 1. 架构概览

本项目采用 分层架构（Layered Architecture） ，用于清晰地区分数据获取、指标计算、可视化逻辑与展示层的职责。

在当前阶段（V1），该架构的核心目标是：

- 明确各模块的 职责边界 
- 避免数据源与分析逻辑之间的 强耦合 
- 支持未来扩展（如多公司对比、实时数据）， 无需重构现有系统 

当前版本在设计上 刻意优先保证流程完整性与系统稳定性 ，而非一次性实现大量功能。

---

## 2. 分层设计

### 2.1 数据提供层（Data Provider Layer）

 职责   
- 从外部数据源获取原始财务数据  
- 不参与任何指标计算或格式化逻辑  

 当前实现   
- `FinanceToolkit`（底层数据来自 Yahoo Finance / Financial Modeling Prep）

 说明   
- 由于 API 限速或套餐限制，该层可能返回空数据或不完整数据  
- 此类问题应在下游处理，不得导致系统崩溃  

---

### 2.2 适配与指标计算层（Adapter & Metrics Layer）

 职责   
- 规范化原始财务字段  
- 根据预定义公式计算派生财务指标  
- 作为指标计算的 唯一可信来源（Single Source of Truth） 

 核心模块   
- `ft_adapter.py`

 设计原则   
- 指标定义与公式不应硬编码在逻辑中  
- 每个指标都必须能追溯到其原始财务字段  

---

### 2.3 格式化与安全层（Formatting & Safety Layer）

 职责   
- 统一数值单位与展示形式  
- 安全处理缺失值与除零情况  
- 防止因数据不完整导致的运行时错误  

 典型功能   
- 安全除法（safe divide）  
- 单位规范化  
- NaN 传播与前端展示一致性  

该层的目标是确保：  
 数据质量问题不会直接影响前端展示或系统稳定性 。

---

### 2.4 可视化层（Plotting Layer）

 职责   
- 基于指标元数据生成图表  
- 根据预定义的绘图规则选择图形类型  
- 与具体经济含义解耦  

 设计约束   
- 绘图逻辑不得依赖具体指标名称  
- 图表行为完全由元数据（如 plot_mode、group_key）控制  

在当前版本中，可视化层主要支持：  
-  单公司、多期的趋势分析 

---

### 2.5 展示层（Presentation Layer）

 职责   
- 提供用户交互与可视化结果展示  
- 展示图表与格式化后的指标数据  
- 不得执行任何数据计算逻辑  

 当前实现   
- 基于 Streamlit 的前端界面  

---

## 3. 以指标为中心的设计理念

系统采用 以指标为中心（Indicator-Centered）的设计思想 ：

- 指标定义、经济含义与绘图规则集中存放于 `indicator_schema.md`
- 新增指标时：
  - 不需要修改绘图逻辑
  - 不需要修改前端逻辑
  - 仅需扩展指标 schema

该设计显著降低了维护成本，并提升了系统透明度与可解释性。

---

## 4. 当前版本的功能边界（V1）

为保证流程完整与结果可靠，以下限制是 有意为之的设计选择 ：

- 仅支持 单公司、多期 分析  
- 不支持跨公司横向对比  
- 不支持实时或高频市场数据  
- 不支持双坐标轴或混合单位图表  

这些限制均已明确记录，以避免产生误导性的分析结论。

---

## 5. 扩展策略（未来工作）

当前架构在设计时已充分考虑未来扩展需求，且无需改变现有结构。

### 计划中的扩展方向
- 多公司同一时期的横向对比（柱状图）
- 新的数据源接入（如实时行情）
- 高级分析层（如杜邦分析、评分模型）

### 扩展方式
- 新数据源将实现统一的数据接口  
- 新分析逻辑将作为独立模块添加  
- 现有各层保持不变  

该策略确保系统具备 前向兼容性与架构稳定性 。

---

## 6. 总结

该架构通过清晰的职责划分，为项目提供了稳定、可扩展的基础。

当前阶段的核心理念是：

>  “先确保完整、可靠、可解释；再逐步丰富功能。” 

### 架构状态  
✅ 架构已定义  
✅ 核心逻辑已实现  
✅ 已具备扩展能力  

---

